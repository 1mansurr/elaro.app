name: Lint Edge Functions

on:
  pull_request:
    paths:
      - 'supabase/functions/**'
      - '.github/workflows/lint-edge-functions.yml'
  push:
    branches: [main, develop]
    paths:
      - 'supabase/functions/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.43.0

      - name: Lint Edge Functions
        run: |
          cd supabase/functions
          deno lint --config deno.json

      - name: Check TypeScript
        run: |
          cd supabase/functions
          # Check each function's main entry point (index.ts)
          # This ensures we check the complete module graph for each function
          ERROR_COUNT=0
          for dir in */; do
            if [ -f "${dir}index.ts" ]; then
              echo "üîç Checking ${dir}index.ts..."
              if ! deno check --config deno.json "${dir}index.ts"; then
                echo "‚ùå TypeScript errors found in ${dir}index.ts"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              fi
            fi
          done
          # Check root-level TypeScript files if any
          for file in *.ts; do
            if [ -f "$file" ] && [ "$file" != "deno.lock" ]; then
              echo "üîç Checking $file..."
              if ! deno check --config deno.json "$file"; then
                echo "‚ùå TypeScript errors found in $file"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              fi
            fi
          done
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "‚ùå Found TypeScript errors in $ERROR_COUNT file(s)"
            exit 1
          fi
          echo "‚úÖ All TypeScript checks passed"

      - name: Format Check
        run: |
          cd supabase/functions
          deno fmt --check

